pipeline {
    agent any
    
    environment {
        DOCKERHUB_USER = "rwurdig"
        IMAGE = "study-buddy-ai"
        APP_DIR = "week_7/study-buddy-ai"
    }
    
    stages {
        stage("Build") {
            steps {
                sh "docker build -t ${DOCKERHUB_USER}/${IMAGE}:${BUILD_NUMBER} ${APP_DIR}"
            }
        }
        
        stage("Push") {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh '''
                        echo "$PASS" | docker login -u "$USER" --password-stdin
                        docker push ${DOCKERHUB_USER}/${IMAGE}:${BUILD_NUMBER}
                    '''
                }
            }
        }
        
        stage("Update manifest") {
            steps {
                sh "sed -i 's|image: .*|image: ${DOCKERHUB_USER}/${IMAGE}:${BUILD_NUMBER}|' ${APP_DIR}/manifests/deployment.yaml"
                
                withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GH_USER', passwordVariable: 'GH_TOKEN')]) {
                    sh '''
                        git config user.email "jenkins@ci"
                        git config user.name "jenkins"
                        git add ${APP_DIR}/manifests/deployment.yaml
                        git commit -m "deploy ${IMAGE}:${BUILD_NUMBER}" || true
                        git push https://${GH_USER}:${GH_TOKEN}@github.com/rwurdig/GenAI_bootcamp.git HEAD:main
                    '''
                }
            }
        }
    }
}
